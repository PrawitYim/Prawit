using UnityEngine;
using UnityEngine.AI;

public class MonsterAI : MonoBehaviour
{
    public Transform[] patrolPoints; // ?????????????????????????
    public float patrolSpeed = 2f; // ??????????????????????????????
    public float patrolDelay = 3f; // ???????????????????????????????????????
    public int attackDamage = 10; // ????????????????????????????
    public float detectionRange = 10f; // ?????????????????????

    private NavMeshAgent navMeshAgent; // ??????????????????????????????
    public Animator animator; // ???????????????????????????????????
    public GameObject player; // ???????????????????
    private bool isPatrolling = false; // ????????????????
    private int currentPatrolPointIndex = 0; // ???????????????????????
    private bool isAttacking = false; // ?????????????

    void Start()
    {
        navMeshAgent = GetComponent<NavMeshAgent>(); // ?????? NavMeshAgent ??? GameObject
        animator = GetComponent<Animator>(); // ?????? Animator ??? GameObject
        player = GameObject.FindGameObjectWithTag("Player"); // ????? GameObject ????? Tag "Player"

        // ?????????????????????????????????????????????????
        Vector3[] patrolPositions = new Vector3[patrolPoints.Length];
        for (int i = 0; i < patrolPoints.Length; i++)
        {
            patrolPositions[i] = patrolPoints[i].position;
        }

        Patrol(); // ???????????????????
    }

    void Update()
    {
        // ?????????????????????????????????????????
        float distanceToPlayer = Vector3.Distance(transform.position, player.transform.position);

        if (distanceToPlayer <= detectionRange)
        {
            // ???????????????????????????????????????????????
            if (!isAttacking)
            {
                StopPatrolling();
                AttackPlayer();
            }
        }
        else
        {
            // ????????????????????????????????????????????
            if (!isPatrolling)
            {
                Patrol();
            }
        }
    }

    void Patrol()
    {
        isPatrolling = true; // ??????????????????????
        isAttacking = false; // ????????????????????????????
        navMeshAgent.speed = patrolSpeed; // ??????????????????????????????????

        // ???????????????????????????????????????????????????
        navMeshAgent.SetDestination(patrolPoints[currentPatrolPointIndex].position);
        animator.SetBool("isWalking", true); // ???????????????????
        currentPatrolPointIndex = (currentPatrolPointIndex + 1) % patrolPoints.Length; // ???????????????????????????
    }

    void StopPatrolling()
    {
        isPatrolling = false; // ??????????????????????????????
        navMeshAgent.ResetPath(); // ????????????????????
        animator.SetBool("isWalking", false); // ??????????????????
    }

    void AttackPlayer()
    {
        isAttacking = true; // ????????????????????????????
        navMeshAgent.speed = 0f; // ???????????????????????
        animator.SetTrigger("attack"); // ????????????????????????

        // ?????????????????
        PlayerHP playerHealth = player.GetComponent<PlayerHP>();
        if (playerHealth != null)
        {
            playerHealth.TakeDamage(attackDamage);
        }

        // ??????????????????????????????????????
        float attackDuration = 1f; // ????????????????
        Invoke("ResumePatrolling", attackDuration);
    }

    void ResumePatrolling()
    {
        // ????????????????????????????
        isAttacking = false;
        Patrol();
    }
}
